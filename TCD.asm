; Projeto de controlador de umidade do solo
#include <p16F873A.inc>

CBLOCK 0x20
	D1
	D2
	D3
	CNT0
	CNT1
ENDC

	ORG 0x0000
	GOTO INICIO

CONFIG_GERAL: ; ROTINA DE CONFIGURAÇÃO GERAL DO PROGRAMA
	; seleciona banco onde está TRISB
	BANKSEL TRISB
	CLRF TRISB
	; rb7 será output
	MOVLW B'00001101'
	MOVWF TRISB

	BANKSEL TRISA
	MOVLW B'11111111'
	MOVWF TRISA

	RETURN

DELAY_1:
	; rotina de delay antes de ligar o sensor (20s)
LOOP:
	MOVLW 0xB5 ; W = 181
	MOVWF D1 ; D1 = W
	MOVLW 0x99; w = 153
	MOVWF D2 ; D2 = W
	MOVLW 0x2C ; W = 44
	MOVWF D3 ; D3 = W
DELAY_1A:
	DECFSZ D1, F
	GOTO $+2
	DECFSZ D2, F
	GOTO $+2
	DECFSZ D3, F
	GOTO DELAY_1A

	GOTO $+1
	NOP

	RETURN

DELAY_2:
	; rotina depois de ligar o sensor (10s)
	MOVLW 0x5A ; W = 90
	MOVWF D1 ; D1 = W
	MOVLW 0xCD; w = 205
	MOVWF D2 ; D2 = W
	MOVLW 0x16 ; W = 22
	MOVWF D3 ; D3 = W
DELAY_2A:
	DECFSZ D1, F
	GOTO $+2
	DECFSZ D2, F
	GOTO $+2
	DECFSZ D3, F
	GOTO DELAY_2A

	RETURN

ADC_CONFIG:
	; configuração do conversor A/D
	BANKSEL ADCON1
	
	; configura AD para ajustar à direita
	MOVLW B'10000000'
	MOVWF ADCON1

	BANKSEL ADCON0

	; 11 - usa clock interno
	; 000 - seleciona porta RA0
	; 0 - GODONE em baixo
	; ignorado
	; 1 ativa A/D
	MOVLW B'11000001'
	MOVWF ADCON0

	RETURN

ADC_LEIA:
	BANKSEL ADCON0
	; salva valores em CNT1 - Alto e CNT0 - Baixo
	BSF ADCON0, 2
LOOP_LEIA:
	BTFSC ADCON0, 2
	GOTO LOOP_LEIA

	BANKSEL ADRESH
	MOVF ADRESH, W
	BANKSEL CNT1	
	MOVWF CNT1

	MOVLW	0X03
	MOVWF	D1
	MOVLW	0X18
	MOVWF	D2
	MOVLW	0X02
	MOVWF	D3
DELAY_LEIA:
	DECFSZ	D1, F
	GOTO	$+2
	DECFSZ	D2, F
	GOTO	$+2
	DECFSZ	D3, F
	GOTO	DELAY_LEIA

	GOTO	$+1
	GOTO	$+1
	GOTO	$+1

	BANKSEL ADRESL
	MOVF ADRESL, W
	BANKSEL CNT0
	MOVWF CNT0

	RETURN

CONFIG_SERIAL:
	; configura TXSTA
	BANKSEL TXSTA
	MOVLW B'00100110'
	MOVWF TXSTA

	BANKSEL RCSTA
	MOVLW B'10010000'
	MOVWF RCSTA

	BANKSEL SPBRG
	MOVLW D'25'
	MOVWF SPBRG

	BANKSEL PIE1
	BCF PIE1, 4
	BCF PIE1, 5

	RETURN 

TRANSMITE_SERIAL:
	BANKSEL CNT1
	MOVF CNT1, W
	BANKSEL TXREG
	MOVWF TXREG
	BANKSEL TXSTA
LOOP_SERIAL:
	BTFSS TXSTA, TRMT
	GOTO LOOP_SERIAL

	MOVLW	0X03
	MOVWF	D1
	MOVLW	0X18
	MOVWF	D2
	MOVLW	0X02
	MOVWF	D3
DELAY_SERIAL:
	DECFSZ	D1, F
	GOTO	$+2
	DECFSZ	D2, F
	GOTO	$+2
	DECFSZ	D3, F
	GOTO	DELAY_SERIAL

	GOTO	$+1
	GOTO	$+1
	GOTO	$+1

	BANKSEL CNT0
	MOVF CNT0, W
	BANKSEL TXREG
	MOVWF TXREG
	BANKSEL TXSTA
LOOP_SERIAL2:
	BTFSS TXSTA, TRMT
	GOTO LOOP_SERIAL2

	RETURN

ALTERA_LEDS:
	BANKSEL CNT1
	DECFSZ CNT1, 0 ; se cnt 1 for 1, liga led azul pra indicar que está úmido
	GOTO PULA
	BANKSEL PORTB
	BSF PORTB,5
	GOTO FIM_LEDS
PULA:
	; se não acende led vermelho
	BANKSEL PORTB
	BSF PORTB,4
	GOTO FIM_LEDS
FIM_LEDS: RETURN
;--------
INICIO:
	CALL CONFIG_GERAL
	CALL CONFIG_SERIAL ; CHAMA ROTINA PARA CONFIGURAÇÃO TRANSMISSÃO NO SERIAL
	BANKSEL PORTB
	BCF PORTB,5
	BCF PORTB,4

VOLTA:
	BANKSEL PORTB
	
	; CALL DELAY_1

	BSF PORTB,7
	
	CALL DELAY_2
	CALL ADC_CONFIG ; CHAMA ROTINA DE CONFIGURAÇÃO DO CONVERSOR AD
	CALL ADC_LEIA ; CHAMA ROTINA DE LEITURA DO CONVERSOR AD

	CALL TRANSMITE_SERIAL; CHAMA ROTINA PARA TRANSMITIR VIA SERIAL

	CALL ALTERA_LEDS
	CALL DELAY_2

	BANKSEL PORTB

	BCF PORTB,5
	BCF PORTB,4
	BCF PORTB,7
	CALL DELAY_2

	GOTO VOLTA

	END
