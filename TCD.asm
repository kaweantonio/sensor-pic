; Projeto de controlador de umidade do solo
#include <p16F873A.inc>

CBLOCK 0x20
	D1
	D2
	D3
	CNT0
	CNT1
ENDC

	ORG 0x0000
	GOTO INICIO

;--------
INICIO:
	CALL CONFIG_GERAL

	BANKSEL PORTB

	BCF PORTB,7
	
	CALL DELAY_1

	BSF PORTB,7

	CALL ADC_CONFIG ; CHAMA ROTINA DE CONFIGURAÇÃO DO CONVERSOR AD
	
	CALL ADC_LEIA ; CHAMA ROTINA DE LEITURA DO CONVERSOR AD

	BANKSEL TXSTA
	MOVLW B'00100110'
	MOVWF 
	
	BANKSEL PORTB

	CALL DELAY_2

	BCF PORTB,7

	GOTO LOOP

	END

CONFIG_GERAL: ; ROTINA DE CONFIGURAÇÃO GERAL DO PROGRAMA
	; configura portB como output
	BANKSEL TRISB
	CLRF TRISB

	MOVLW B'00000001'
	MOVWF TRISB

DELAY_1:
	; rotina de delay antes de ligar o sensor (20s)
LOOP:
	MOVLW 0xB5 ; W = 181
	MOVWF D1 ; D1 = W
	MOVLW 0x99; w = 153
	MOVWF D2 ; D2 = W
	MOVLW 0x2C ; W = 44
	MOVWF D3 ; D3 = W
DELAY_1A:
	DECFSZ D1, F
	GOTO $+2
	DECFSZ D2, F
	GOTO $+2
	DECFSZ D3, F
	GOTO DELAY_1A

	GOTO $+1
	NOP

	RETURN

DELAY_2:
	; rotina depois de ligar o sensor (10s)
	MOVLW 0x5A ; W = 90
	MOVWF D1 ; D1 = W
	MOVLW 0xCD; w = 205
	MOVWF D2 ; D2 = W
	MOVLW 0x16 ; W = 22
	MOVWF D3 ; D3 = W
DELAY_2A:
	DECFSZ D1, F
	GOTO $+2
	DECFSZ D2, F
	GOTO $+2
	DECFSZ D3, F
	GOTO DELAY_2A

	RETURN

ADC_CONFIG:
	; configuração do conversor A/D
	BANKSEL ADCON1

	MOVLW B'10000000'
	MOVWF ADCON1

	BANKSEL ADCON0

	MOVLW B'11000001'
	MOVWF ADCON0

	RETURN

ADC_LEIA:
	; salva valores em CNT1 - Alto e CNT0 - Baixo
	BSF ADCON0, 2
ESPERA:
	BTFSC ADCON0, 2
	GOTO ESPERA

	MOVF ADRESH, w
	MOVWF CNT1
	MOVF ADRESL, w
	MOVWF CNT0

	RETURN
